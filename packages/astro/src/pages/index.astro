---
import crypto from 'crypto'
import Layout from '../layouts/Layout.astro'
import { PutObjectCommand, S3Client } from '@aws-sdk/client-s3'
import { getSignedUrl } from '@aws-sdk/s3-request-presigner'
import { Bucket } from 'sst/node/bucket'

const client = new S3Client({
  region: 'us-east-1',
})

const command = new PutObjectCommand({
  ACL: 'public-read',
  Key: crypto.randomUUID(),
  Bucket: Bucket.images.bucketName,
})

const url = await getSignedUrl(client, command)
---

<Layout title="Astro x SST">
  <main>
    <form action={url}>
      <input name="file" type="file" accept="image/png, image/jpeg" />
      <button type="submit">Upload</button>
    </form>
    <script>
      const form = document.querySelector('form')
      form!.addEventListener('submit', async (e) => {
        e.preventDefault()

        const file = form!.file.files?.[0]!

        const image = await fetch(form!.action, {
          body: file,
          method: 'PUT',
          headers: {
            'Content-Type': file.type,
            'Content-Disposition': `attachment; filename="${file.name}"`,
          },
        })

        window.location.href = image.url.split('?')[0] || '/'
      })
    </script>
  </main>
</Layout>
